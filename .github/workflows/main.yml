name: Build ValeAI FINAL
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Reparar Faltantes y Construir
        run: |
          # 1. Encontrar la carpeta raíz de Android (sea androide, android, etc.)
          ROOT_DIR=$(find . -name "gradlew" -printf '%h\n' | head -n 1)
          
          if [ -z "$ROOT_DIR" ]; then
             echo "CRITICAL ERROR: No gradlew found."
             exit 1
          fi

          echo "Entrando a: $ROOT_DIR"
          cd "$ROOT_DIR"

          # 2. CREAR LOS ARCHIVOS QUE FALTAN (Esto arregla el error de Grok y el anterior)
          echo "Creando archivos fantasma para Capacitor..."
          
          mkdir -p capacitor-cordova-android-plugins/src/main
          
          # Archivo 1: El que causó el error de la X roja anterior
          echo 'ext = []' > capacitor-cordova-android-plugins/cordova.variables.gradle
          
          # Archivo 2: Un build.gradle vacío para que no falle el módulo
          echo 'buildscript { repositories { google(); mavenCentral() } }' > capacitor-cordova-android-plugins/build.gradle
          
          # Archivo 3: Un manifiesto falso necesario
          echo '<manifest package="ca.capacitor.cordova.plugins"/>' > capacitor-cordova-android-plugins/src/main/AndroidManifest.xml

          # 3. Compilar a la fuerza
          chmod +x gradlew
          ./gradlew assembleDebug -x lint -x test --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ValeAI-debug
          path: "**/*.apk"
